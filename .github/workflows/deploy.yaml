name: Deployment
on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "src/**"
jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: "recursive"
      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          # TODO: use stable once https://github.com/foundry-rs/foundry/pull/9979 is released.
          version: nightly
      - name: Deploy
        env:
          PRIVATE_KEY: ${{ secrets.deployer }}
        # TODO: remove the --evm-version argument once https://github.com/blockscout/blockscout/pull/12115 is released.
        run: |
          echo "Deploying";
          forge script DeployAllScript \
            --rpc-url "https://odyssey-devnet.ithaca.xyz" \
            --broadcast -q \
            --evm-version cancun;

          echo "Verifying EntryPoint";
          forge verify-contract $(jq -r '.transactions[].additionalContracts | .[0].address' broadcast/DeployAll.s.sol/911867/run-latest.json) \
            DeployAllScript \
            --chain odyssey \
            --skip-is-verified-check \
            --verifier blockscout \
            --verifier-url "https://odyssey-devnet.ithaca.xyz/api" || true;

          echo "Verifying Delegation";
          forge verify-contract $(jq -r '.transactions[].additionalContracts | .[1].address' broadcast/DeployAll.s.sol/911867/run-latest.json) \
            DeployAllScript \
            --chain odyssey \
            --skip-is-verified-check \
            --verifier blockscout \
            --verifier-url "https://odyssey-devnet.ithaca.xyz/api" || true;

          echo "Compiling EIP7702Proxy fixed bytecode";
          forge clean;
          forge build;
          cp lib/solady/src/accounts/EIP7702Proxy.sol src/EIP7702Proxy.sol;
          forge build --use=0.8.28 --optimizer-runs=200 --evm-version=cancun || true;

          echo "Verifying EIP7702Proxy";
          forge verify-contract $(jq -r '.transactions[].additionalContracts | .[2].address' broadcast/DeployAll.s.sol/911867/run-latest.json)  \
            "src/EIP7702Proxy.sol:EIP7702Proxy" \
            --compiler-version=0.8.28 \
            --optimizer-runs=200 \
            --evm-version=cancun \
            --constructor-args $(jq -r '.transactions[].additionalContracts | .[1].address' broadcast/DeployAll.s.sol/911867/run-latest.json | sed 's/^0x//' | xargs -I{} printf '0x000000000000000000000000%s0000000000000000000000000000000000000000000000000000000000000000' {}) \
            --chain odyssey \
            --skip-is-verified-check \
            --verifier blockscout \
            --verifier-url "https://odyssey-devnet.ithaca.xyz/api" || true;

          echo "Cleaning up EIP7702Proxy verification";
          rm src/EIP7702Proxy.sol;
